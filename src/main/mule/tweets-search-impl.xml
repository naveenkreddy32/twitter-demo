<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	
	<sub-flow name="tweets-search-impl-subflow" doc:id="a9d77eaa-3ebd-434f-99e3-b3ed44ee0fbe" >
		
		<flow-ref doc:name="common-twitter-invocation-subflow" doc:id="a3cbdf57-2948-45da-968a-5274d6f2cd26" name="common-twitter-invocation-subflow"/>
		<ee:transform doc:name="Prepare JSON Response" doc:id="899cfcb4-edfd-4cb7-b45c-64e09c67ad0c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json

type Dformat = DateTime {format: "E MMM dd HH:mm:ss xx yyyy"}

var noOfHours = vars.queryParams.noOfHours default 0
var current = now() as Dformat
var reqDatetime = current - ("PT$(noOfHours)H" as Period)

---
{
	tweets: payload.statuses filter (($.created_at as Dformat) > reqDatetime) map ( tweet , indexOfStatus ) -> {
		text: tweet.full_text,
		url: "https://twitter.com/demomuleapi/status/" ++ tweet.id_str,
		screenname: tweet.user.screen_name,
		//created_at: tweet.created_at
	}
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
	</sub-flow>
</mule>
